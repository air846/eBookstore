<view class="container reader {{darkMode ? 'dark' : ''}}">
  <view class="card">
    <view class="toolbar">
      <picker class="picker-wrap" mode="selector" range="{{chapterTitles}}" value="{{currentIndex}}" bindchange="onChapterChange">
        <view class="picker">ç« èŠ‚ï¼š{{chapterTitles[currentIndex] || 'æš‚æ— ç« èŠ‚'}}</view>
      </picker>
      <button size="mini" bindtap="changeFontSize" data-action="dec">A-</button>
      <button size="mini" bindtap="changeFontSize" data-action="inc">A+</button>
      <button size="mini" bindtap="toggleTheme">{{darkMode ? 'æ—¥é—´' : 'å¤œé—´'}}</button>
    </view>

    <view class="mode-row">
      <text class="sub">åˆ†æ®µï¼š</text>
      <button size="mini" class="{{paragraphMode===1 ? 'mode-active' : ''}}" data-mode="1" bindtap="setParagraphMode">ä¸€æ®µå¼</button>
      <button size="mini" class="{{paragraphMode===2 ? 'mode-active' : ''}}" data-mode="2" bindtap="setParagraphMode">äºŒæ®µå¼</button>
      <button size="mini" class="{{paragraphMode===3 ? 'mode-active' : ''}}" data-mode="3" bindtap="setParagraphMode">ä¸‰æ®µå¼</button>
      <text class="sub progress">è¿›åº¦ï¼š{{progressText}}</text>
    </view>
    <view class="sub">é•¿æŒ‰æ®µè½å¯è¯„è®ºï¼›æœ‰è¯„è®ºæ—¶æ®µè½ç»“å°¾æ˜¾ç¤ºç•ªèŒ„æ°”æ³¡</view>

    <view class="error" wx:if="{{errorText}}">{{errorText}}</view>
    <view class="loading" wx:if="{{loading}}">åŠ è½½ä¸­...</view>

    <view wx:if="{{!loading}}">
      <view id="chapterTop"></view>
      <view class="paragraph-block" wx:for="{{paragraphBlocks}}" wx:key="key">
        <view class="paragraph" style="font-size: {{fontSize}}rpx;" data-start="{{item.start}}" bindlongpress="onParagraphLongPress">
          <text selectable>{{item.text}}</text>
          <text
            class="comment-bubble-inline"
            wx:if="{{(item.commentCount || 0) > 0}}"
            data-start="{{item.start}}"
            bindtap="openComments"
          >
            ğŸ…{{item.commentCount}}
          </text>
        </view>
      </view>
    </view>

    <view class="chapter-actions">
      <button size="mini" bindtap="prevChapter" disabled="{{currentIndex === 0}}">ä¸Šä¸€ç« </button>
      <button size="mini" bindtap="nextChapter" disabled="{{currentIndex >= chapters.length - 1}}">ä¸‹ä¸€ç« </button>
      <button size="mini" type="primary" bindtap="urgeUpdate" wx:if="{{isLastChapter}}">å‚¬æ›´</button>
    </view>
  </view>

  <view class="comment-mask" wx:if="{{commentVisible}}" bindtap="closeCommentPanel"></view>
  <view class="comment-panel {{darkMode ? 'dark' : ''}}" wx:if="{{commentVisible}}" catchtap="stopBubble">
    <view class="comment-head">
      <view class="title">æ®µè¯„ï¼ˆç¬¬ {{selectedParagraphIndex + 1}} æ®µï¼‰</view>
      <button size="mini" bindtap="closeCommentPanel">å…³é—­</button>
    </view>

    <view class="sort-row">
      <button size="mini" class="{{commentSort==='time' ? 'mode-active' : ''}}" data-sort="time" bindtap="setCommentSort">æœ€æ–°</button>
      <button size="mini" class="{{commentSort==='hot' ? 'mode-active' : ''}}" data-sort="hot" bindtap="setCommentSort">æœ€çƒ­</button>
    </view>

    <view class="reply-tip" wx:if="{{replyHint}}">
      <text>{{replyHint}}</text>
      <button size="mini" bindtap="cancelReply">å–æ¶ˆ</button>
    </view>

    <textarea class="comment-input" placeholder="è¯´ç‚¹ä»€ä¹ˆå§" value="{{commentInput}}" bindinput="onCommentInput" />
    <button class="submit-btn" type="primary" size="mini" loading="{{commentSubmitting}}" bindtap="submitComment">æäº¤è¯„è®º</button>

    <scroll-view class="comment-list" scroll-y>
      <view class="loading" wx:if="{{commentLoading}}">åŠ è½½ä¸­...</view>
      <view class="sub" wx:if="{{!commentLoading && !comments.length}}">æš‚æ— è¯„è®º</view>

      <view class="comment-item" wx:for="{{comments}}" wx:key="id">
        <view wx:if="{{!item.hidden}}">
          <view class="comment-user">
            <image wx:if="{{item.avatar}}" class="avatar" src="{{item.avatar}}" mode="aspectFill"></image>
            <view class="avatar-fallback" wx:else>{{item.displayName && item.displayName[0] || 'åŒ¿'}}</view>
            <text>{{item.displayName}}</text>
          </view>
          <view class="comment-content">{{item.content}}</view>
          <view class="comment-meta sub">{{item.createTimeText}} Â· èµ {{item.likeCount || 0}} / è¸© {{item.dislikeCount || 0}}</view>
          <view class="comment-actions">
            <button size="mini" data-id="{{item.id}}" data-value="{{item.userReaction===1 ? 0 : 1}}" bindtap="onReact">{{item.userReaction===1 ? 'å–æ¶ˆèµ' : 'ç‚¹èµ'}}</button>
            <button size="mini" data-id="{{item.id}}" data-value="{{item.userReaction===-1 ? 0 : -1}}" bindtap="onReact">{{item.userReaction===-1 ? 'å–æ¶ˆè¸©' : 'æ‹‰è¸©'}}</button>
            <button size="mini" data-parentid="{{item.id}}" data-username="{{item.displayName}}" bindtap="startReply">å›å¤</button>
            <button size="mini" data-id="{{item.id}}" bindtap="onHide">æŠ˜å </button>
          </view>
        </view>
        <view wx:else>
          <view class="sub">è¯¥è¯„è®ºå·²æŠ˜å </view>
          <button size="mini" data-id="{{item.id}}" bindtap="onUnhide">å±•å¼€</button>
        </view>

        <view class="reply-item" wx:for="{{item.replies}}" wx:key="id">
          <view wx:if="{{!item.hidden}}">
            <view class="comment-user">
              <image wx:if="{{item.avatar}}" class="avatar" src="{{item.avatar}}" mode="aspectFill"></image>
              <view class="avatar-fallback" wx:else>{{item.displayName && item.displayName[0] || 'åŒ¿'}}</view>
              <text>{{item.displayName}}</text>
            </view>
            <view class="comment-content">{{item.content}}</view>
            <view class="comment-meta sub">{{item.createTimeText}} Â· èµ {{item.likeCount || 0}} / è¸© {{item.dislikeCount || 0}}</view>
            <view class="comment-actions">
              <button size="mini" data-id="{{item.id}}" data-value="{{item.userReaction===1 ? 0 : 1}}" bindtap="onReact">{{item.userReaction===1 ? 'å–æ¶ˆèµ' : 'ç‚¹èµ'}}</button>
              <button size="mini" data-id="{{item.id}}" data-value="{{item.userReaction===-1 ? 0 : -1}}" bindtap="onReact">{{item.userReaction===-1 ? 'å–æ¶ˆè¸©' : 'æ‹‰è¸©'}}</button>
              <button size="mini" data-parentid="{{item.parentId}}" data-username="{{item.displayName}}" bindtap="startReply">å›å¤</button>
              <button size="mini" data-id="{{item.id}}" bindtap="onHide">æŠ˜å </button>
            </view>
          </view>
          <view wx:else>
            <view class="sub">è¯¥å›å¤å·²æŠ˜å </view>
            <button size="mini" data-id="{{item.id}}" bindtap="onUnhide">å±•å¼€</button>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>
</view>
